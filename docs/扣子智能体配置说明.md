# 扣子智能体配置说明

在扣子平台搭建好智能体后，按以下步骤配置，即可在「智学英语 Hub」站内通过 API 调用，并将对话同时保存到 Supabase。

---

## 一、在扣子平台创建并发布智能体

### 1. 创建智能体（Bot）

1. 登录扣子：**国内** [https://www.coze.cn](https://www.coze.cn) / **国际** [https://www.coze.com](https://www.coze.com)
2. 进入「空间」→ 选择或新建空间
3. 点击「创建 Bot」→ 填写名称、描述，选择模型与设定人设/提示词
4. 在对话预览里调试到满意为止

### 2. 发布为 API 服务（关键）

只有发布为 API 后，网站才能通过接口调用该智能体。

1. 在智能体编辑页右上角点击 **「发布」**
2. 选择 **「API」** 或 **「Bot as API」** 相关选项（不同版本文案可能为「开放平台」「API 服务」等）
3. 若需审核则等待通过；部分空间支持「跳过并直接发布」
4. 发布成功后，该 Bot 会获得可被 API 调用的状态

### 3. 获取 Bot ID

发布后需要把 Bot 的唯一 ID 填到本站的 `constants.ts` 里（对应每个工具的 `cozeBotId`）。

- **方式一（推荐）**：发布页或 Bot 详情页会显示「Bot ID」或「机器人 ID」，直接复制
- **方式二**：从浏览器地址栏获取  
  打开该 Bot 的页面，URL 形如：  
  `https://www.coze.cn/space/xxxxx/bot/7498549748861763619`  
  或  
  `https://www.coze.com/space/xxxxx/bot/73428668xxxxx`  
  其中 **`/bot/` 后面的那一串数字** 即为 **Bot ID**。

---

## 二、获取 API 调用凭证（个人访问令牌 PAT）

网站调用扣子 API 时需要用到 **个人访问令牌（Personal Access Token）**。

### 国内扣子（coze.cn）

1. 登录 [https://www.coze.cn](https://www.coze.cn)
2. 进入 **「扣子开放平台」** 或 **「API」** 相关入口（通常在首页/控制台左侧）
3. 打开 **「授权」** → **「个人访问令牌」** → **「添加 / 新建」**
4. 填写名称、选择权限（至少包含 **会话/对话** 相关权限）、选择可访问空间
5. 生成后 **立即复制并保存**：令牌只显示一次，丢失需重新创建

### 国际版（coze.com）

1. 登录 [https://www.coze.com](https://www.coze.com)
2. 打开 [https://www.coze.com/open/api](https://www.coze.com/open/api) 或控制台中的 API 管理
3. 点击 **「Add Token」**，名称随意，范围选 **「Open API」**
4. 确认后 **复制并保存** 生成的 Token

---

## 三、区分国内 / 国际 API 地址

| 平台     | 扣子网站      | API 基址（用于对话） |
|----------|---------------|------------------------|
| 国内扣子 | coze.cn       | `https://api.coze.cn`  |
| 国际版   | coze.com      | `https://api.coze.com` |

本项目默认使用 **国际版** `https://api.coze.com`。若你使用的是 **国内扣子（coze.cn）**，需要在环境变量中指定国内 API 基址（见下一节）。

---

## 四、在本项目中的配置

### 1. 环境变量（Netlify / 本地）

在 Netlify 或本地 `.env` 中配置：

- **COZE_API_KEY**（必填）  
  上一步在扣子平台生成的 **个人访问令牌（PAT）**。

- **COZE_API_BASE**（可选，国内扣子必填）  
  - 不填或填 `https://api.coze.com`：使用国际版  
  - 使用国内扣子时填：`https://api.coze.cn`

示例（国内扣子）：

```env
COZE_API_KEY=pat_xxxxxxxxxxxxxxxxxxxxxxxx
COZE_API_BASE=https://api.coze.cn
```

### 2. 在代码中绑定 Bot ID

在 `constants.ts` 的 `TOOLS` 里，为要在站内对话的智能体填写 `cozeBotId`（不要填 `externalLink` 则走站内对话；若同时有 `externalLink` 会优先跳转外链）。

示例：

```ts
{
    id: 'my-coze-agent',
    title: '我的扣子智能体',
    description: '...',
    category: '...',
    categoryColor: '...',
    systemInstruction: '', // 站内走 Coze 时可留空
    cozeBotId: '7498549748861763619',  // 扣子后台的 Bot ID
    // 不设 externalLink，用户点击「开始」会在本站弹窗里对话
}
```

- **Bot ID** 必须与扣子平台该 Bot 的 ID 一致（国内/国际各自在对应平台查）。
- 同一 Bot 只需配置一次；若某工具只做外链跳转，只填 `externalLink` 不填 `cozeBotId` 即可。

---

## 五、对话如何同时存到 Supabase

### 场景 1：在本站弹窗对话（`cozeBotId`）

无需在扣子平台做额外配置：

- 扣子侧：交互记录仍按扣子规则存在扣子后台（含对话历史、会话等）。
- 本站：在用户每轮对话结束后，前端会调用 Netlify Function `save-conversation`，把本条「用户输入 + 机器人回复」写入 Supabase 表（如 `conversations`），实现双写。

### 场景 2：跳转到扣子官网（`externalLink`）后也要同步

本项目已新增定时函数：`netlify/functions/sync-coze-conversations.js`。  
它会按 `COZE_SYNC_BOT_IDS` 拉取扣子会话消息，再写入 Supabase `conversations`。

你需要在 Netlify 增加环境变量：

- `COZE_API_KEY`：扣子 PAT
- `COZE_API_BASE`：国内填 `https://api.coze.cn`，国际填 `https://api.coze.com`
- `COZE_SYNC_BOT_IDS`：要同步的 Bot ID，逗号分隔
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `SUPABASE_CONVERSATIONS_SCHEMA`：默认 `public`

并在 Supabase 执行 SQL：`docs/supabase-conversations-table.sql`（包含 `conversations` 与 `coze_sync_state`）。

> 注意：跳转到扣子官网时，无法拿到你站点登录态中的用户ID。  
> 定时同步会按扣子会话消息内容配对入库，`student_id` 优先取消息/会话元数据中的 `student_id`、`user_id`，否则记为 `coze_external_user`。

---

## 六、自检清单

- [ ] 扣子 Bot 已创建并 **发布为 API**
- [ ] 已获取该 Bot 的 **Bot ID**，并写入 `constants.ts` 对应工具的 `cozeBotId`
- [ ] 已在扣子开放平台创建 **个人访问令牌（PAT）**，并配置到环境变量 **COZE_API_KEY**
- [ ] 若使用国内扣子，已配置 **COZE_API_BASE=https://api.coze.cn**
- [ ] Netlify 已配置上述环境变量并重新部署

如有 401/403 或连接错误，请先核对 PAT 是否有效、Bot 是否已发布为 API、以及 API 基址是否与使用的扣子平台（国内/国际）一致。
